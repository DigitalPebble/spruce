# Enrichment modules

SPRUCE generates the estimates above by chaining **EnrichmentModules**.
An `EnrichmentModule` is the unit of extension in SPRUCE. Each module reads columns from
the CUR input row and/or from values set by earlier modules, then writes its results into a
shared map. The pipeline materialises one output row per CUR row at the end, avoiding
per-module row copies.

For instance, the [AverageCarbonIntensity.java](https://github.com/DigitalPebble/spruce/blob/main/src/main/java/com/digitalpebble/spruce/modules/electricitymaps/AverageCarbonIntensity.java) module applies average carbon intensity factors to energy estimates based on the region in order to generate _operational emissions_.

The list of columns generated by the modules can be found in the [SpruceColumn](https://github.com/DigitalPebble/spruce/blob/main/src/main/java/com/digitalpebble/spruce/SpruceColumn.java) class.

The enrichment modules are listed and configured in a configuration file. If no configuration is specified, the [default one](https://github.com/DigitalPebble/spruce/blob/main/src/main/resources/default-config.json) is used.
See [Configure the modules](howto/config_modules.md) for instructions on how to modify the enrichment modules.

## Cloud Carbon Footprint

The following modules implement the heuristics from the [Cloud Carbon Footprint](https://www.cloudcarbonfootprint.org/) project. 

### ccf.Storage

Provides an estimate of energy used for storage by applying a flat coefficient per Gb, following the approach used by the [Cloud Carbon Footprint](https://www.cloudcarbonfootprint.org/) project.
Service-specific replication factors are applied.
See [methodology](https://www.cloudcarbonfootprint.org/docs/methodology#storage) for more details.

Populates the column `operational_energy_kwh`.

### ccf.Networking

Provides an estimate of energy used for networking in and out of data centres. Applies a flat coefficient of _0.001 kWh/Gb_ by default, see [methodology](https://www.cloudcarbonfootprint.org/docs/methodology#networking) for more details. The coefficient can be changed via configuration as shown in [Configure the modules](howto/config_modules.md).

Populates the column `operational_energy_kwh`.

### ccf.Accelerators

Provides an estimate of energy used accelerators, following the approach used by the [Cloud Carbon Footprint](https://www.cloudcarbonfootprint.org/) project.
See [methodology](https://www.cloudcarbonfootprint.org/docs/methodology/#graphic-processing-units-gpus) for more details.

Populates the column `operational_energy_kwh`.

## Boavizta

The following modules make use of the [BoaviztAPI](https://doc.api.boavizta.org).

### boavizta.BoaviztAPI

Provides an estimate of [final energy](https://www.eea.europa.eu/en/analysis/indicators/primary-and-final-energy-consumption) used for computation (EC2, OpenSearch, RDS) as well as the related embodied emissions using the [BoaviztAPI](https://doc.api.boavizta.org/).

Populates the columns `operational_energy_kwh`, `embodied_emissions_co2eq_g` and `embodied_adp_sbeq_g`. 

From https://doc.api.boavizta.org/Explanations/impacts/ 

**Abiotic Depletion Potential (ADP)** is an environmental impact indicator. This category corresponds to mineral and resources used and is, in this sense, mainly influenced by the rate of resources extracted. The effect of this consumption on their depletion is estimated according to their availability stock at a global scale. This impact category is divided into two components: a material component and a fossil fuels component (we use a version of ADP which include both).
This impact is expressed in grams of antimony equivalent (gSbeq).

Source: [sciencedirect](https://www.sciencedirect.com/topics/engineering/abiotic-depletion-potential)

### boavizta.BoaviztAPIstatic

Similar to the previous module but does not get the information from an instance of the BoaviztAPI but from a static file generated from it. This makes it simpler to use SPRUCE.

## electricitymaps.AverageCarbonIntensity

Adds average carbon intensity factors generated from [ElectricityMaps](https://www.electricitymaps.com/)' 2024 datasets.
The [life-cycle](https://portal.electricitymaps.com/developer-hub/api/getting-started#emission-factors) emission factors are used.

Populates the columns `carbon_intensity`.

The mapping between the cloud regions IDs and the ElectricityMaps IDs comes from the [GSF Realtime cloud project](https://github.com/Green-Software-Foundation/real-time-cloud), see below.

## Real Time Cloud 

This module does not do any enrichment as such but provides access to data from the RTC project, see above.

## RegionExtraction

Extracts the region information from the input and stores it in a standard location.

Populates the column `region`.

## PUE

Uses the 2024 data published by AWS for [Power Usage_Effectiveness](https://sustainability.aboutamazon.com/aws-wue-pue.csv) to rows for which energy usage has been estimated.
This provides a more accurate and up to date approach than the flat rate approach in the [CCF methodology](https://www.cloudcarbonfootprint.org/docs/methodology/#pue).

Populates the column `power_usage_effectiveness`.

## Serverless

Provides an estimate of energy for the memory and vCPU usage of serverless services like Fargate or EMR.
The default coefficients are taken from the [Tailpipe methodology](https://tailpipe.ai/methodology/serverless-explained/).

Populates the column `operational_energy_kwh`.

## OperationalEmissions

Computes operational emissions based on the energy usage, average carbon intensity factors and `power_usage_effectiveness` estimated by the preceding modules, based on the `region`.

Populates the columns `operational_emissions_co2eq_g`.

`operational_emissions_co2eq_g` is equal to `operational_energy_kwh` * `carbon_intensity` * `power_usage_effectiveness`.


